"0","# perform rotation of the states before plotting"
"0","# get the inverse of the rotation matrix"
"0","Z.est <- coef(mod.me, type = ""matrix"")$Z"
"0","H.inv <- 1"
"0","if (ncol(Z.est) > 1){"
"0","H.inv <- varimax(coef(mod.me, type = ""matrix"")$Z)$rotmat}"
"0",""
"0","# rotate factor loadings"
"0","Z.rot <- Z.est %*% H.inv"
"0","#extract the rotated loadings and reshape into a matrix"
"0","loadings <- t(Z.rot) %>% data.frame()"
"0","colnames(loadings) <- unique(dat$country)"
"0","loadings$x <- c(""X1"",""X2"", ""X3"")"
"0","# add zone to the loadings"
"0","loadings <- loadings %>% "
"0","  pivot_longer(-c(""x""), names_to = ""country"", values_to = ""loading"") %>% "
"0","  mutate(zone = ifelse(country %in% "
"0","    c(""Italy"",""United Kingdom"",""France"",""Germany"",""Spain""),"
"0","    ""Europe"",ifelse( country %in% c (""United States"",""Canada""), ""North America"","
"0","    ifelse(country %in% c(""Japan"", ""India"", ""China""), ""Asia"","
"0","    ifelse(country %in% c(""Argentina"",""Brazil"", ""Peru""),""South America"", ""Oceania"")))))"
"0",""
"0",""
"0","# rotate trends and covnert them to a data frame"
"0","trends.rot <- solve(H.inv) %*% mod.me$states"
"0","trends.rot <- t(trends.rot)"
"0","trends.rot <- data.frame(trends.rot)"
"0",""
"0","# assign column names"
"0","colnames(trends.rot) <- c(""X1"",""X2"",""X3"")"
"0",""
"0","# add year and reshape"
"0","trends.rot$Year <- seq(from = 1910, to = 2018)"
"0","trends.rot <- trends.rot %>% "
"0","  pivot_longer(cols = -c(""Year""),"
"0","              names_to = ""state"", values_to = ""val"") %>% "
"0","  group_by(state) %>% dplyr::arrange(Year, .by_group = TRUE)"
"0",""
"0","# obtain estimated states"
"0","s <- tsSmooth(mod.me)"
"0","colnames(s) <- c(""state"", ""Year"", ""val"",""se"")"
"0","s$statesRot <- trends.rot$state"
"0","s$Year <- rep(seq(from = 1910, to =2018),3)"
"0",""
